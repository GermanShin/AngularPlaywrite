pipeline {
  agent any

  parameters {
    choice(
        name: 'ENV',
        choices: ['dev', 'test', 'stg'],  // List your envs here
        description: 'Select the environment to run Playwright tests against'
    )
    booleanParam(
            name: 'DEPLOY_CDK',
            defaultValue: false,
            description: 'Deploy CDK stack before running tests'
    )
  }

  environment {
      AWS_REGION = "ap-southeast-2"  // Change to your region
  }

  stages {
    stage('Echo Env File') {
      steps {
        echo "Selected env: ${params.ENV_FILE}"
      }
    }


    stage('Check AWS CLI Execution') {
      steps {
          script {
              withCredentials([
                  [$class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'david-shin-iam-user-cred',
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']
              ]) {
                  sh 'aws s3 ls'
                  sh 'aws sts get-caller-identity'
              }
          }
      }
    }

    stage('Synthesize Stack') {
        steps {
            script{
                withCredentials([
                  [$class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'david-shin-iam-user-cred',
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']
              ]){
                    dir('TestAutomation/cdk') {
                        sh 'npm ci'
                        sh 'npm run synth'
                    }
              }
            }

        }
    }

    stage('Deploy CDK Stack (Optional)') {
        when {
            expression { return params.DEPLOY_CDK }
        }
        steps {
            script {
                withCredentials([
                  [$class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'david-shin-iam-user-cred',
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']
                ]) {
                    dir('TestAutomation/cdk') {
                        //Placeholder for actual CDK deploy
                        //echo 'This is the deploy step. CDK deploy is not executed.'
                        sh 'npm ci'
                        sh 'npm install aws-cdk --save-dev'  // Ensure CDK CLI is available
                        sh 'npx cdk deploy --require-approval never'
                    }
                }
            }
        }
    }


    stage('Install deps') {
        steps {
          dir('TestAutomation') {
              sh 'npm ci'
          }
        }
    }

    stage('Run Playwright Tests') {
        steps {
            dir('TestAutomation') {
                sh "ENV=${params.ENV} npx playwright test"
            }
        }
    }
  }
}
